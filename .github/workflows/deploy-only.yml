name: Deploy (Staging & Production)

on:
  # ÊâãÂãïÂÆüË°åÁî®
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - staging
          - production
          - both

  # ‰ªñ„ÅÆ„ÉØ„Éº„ÇØ„Éï„É≠„ÉºÔºàci-cd.ymlÔºâ„Åã„ÇâÂëº„Å≥Âá∫„ÅôÁî®
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
    secrets:
      GCP_SA_KEY:
        required: true
      GCP_PROJECT_ID:
        required: true

permissions:
  contents: read

env:
  NODE_VERSION: "20"
  PNPM_VERSION: "9"
  # workflow_dispatch „Å® workflow_call ‰∏°ÂØæÂøú
  DEPLOY_ENV: ${{ github.event.inputs.environment || inputs.environment }}

jobs:
  # Deploy to Staging Environment
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    # ÊâãÂãïÂÆüË°å: github.event.inputs.environment
    # Âëº„Å≥Âá∫„ÅóÂÆüË°å: inputs.environment
    if: env.DEPLOY_ENV == 'staging' || env.DEPLOY_ENV == 'both'
    environment:
      name: staging
      url: https://mycats-pro-frontend-staging-518939509282.asia-northeast1.run.app
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate required secrets
        run: |
          if [ -z "${{ secrets.GCP_SA_KEY }}" ]; then
            echo "‚ùå Error: GCP_SA_KEY secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.GCP_PROJECT_ID }}" ]; then
            echo "‚ùå Error: GCP_PROJECT_ID secret is not set"
            exit 1
          fi
          echo "‚úÖ All required secrets are configured"

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker asia-northeast1-docker.pkg.dev

      - name: Deploy to Staging using Cloud Build
        run: |
          echo "üöÄ Deploying to staging environment..."
          gcloud builds submit \
            --config=cloudbuild.yaml \
            --substitutions=_BACKEND_SERVICE_NAME=mycats-pro-backend-staging,_FRONTEND_SERVICE_NAME=mycats-pro-frontend-staging,_ENVIRONMENT=staging,_CLOUD_SQL_CONNECTION_NAME=my-cats-pro:asia-northeast1:mycats-stg-db,_CORS_ORIGIN=https://mycats-pro-frontend-staging-518939509282.asia-northeast1.run.app,_NEXT_PUBLIC_API_URL=https://mycats-pro-backend-staging-518939509282.asia-northeast1.run.app/api/v1,_DATABASE_URL_SECRET_NAME=DATABASE_URL_STAGING,_DATABASE_URL_SECRET_VERSION=3,_JWT_SECRET_NAME=JWT_SECRET_STAGING,_JWT_SECRET_VERSION=1,_JWT_REFRESH_SECRET_NAME=JWT_REFRESH_SECRET_STAGING,_JWT_REFRESH_SECRET_VERSION=1,_CSRF_TOKEN_SECRET_NAME=CSRF_TOKEN_SECRET_STAGING,_CSRF_TOKEN_SECRET_VERSION=1 \
            --project=${{ secrets.GCP_PROJECT_ID }}

      - name: Verify Staging Deployment
        run: |
          echo "‚úÖ Staging deployment completed"
          echo "Backend URL: https://mycats-pro-backend-staging-518939509282.asia-northeast1.run.app"
          echo "Frontend URL: https://mycats-pro-frontend-staging-518939509282.asia-northeast1.run.app"

      - name: Test Staging Health Endpoint
        run: |
          echo "üè• Testing staging backend health endpoint..."
          sleep 30
          max_attempts=10
          attempt=0
          while [ $attempt -lt $max_attempts ]; do
            response=$(curl -s -o /dev/null -w "%{http_code}" https://mycats-pro-backend-staging-518939509282.asia-northeast1.run.app/health || echo "000")
            if [ "$response" = "200" ]; then
              echo "‚úÖ Staging backend is healthy (HTTP 200)"
              break
            fi
            attempt=$((attempt + 1))
            echo "‚è≥ Waiting for staging backend to be ready... (attempt $attempt/$max_attempts, got HTTP $response)"
            sleep 10
          done
          if [ $attempt -eq $max_attempts ]; then
            echo "‚ö†Ô∏è Warning: Staging backend did not respond with HTTP 200 after $max_attempts attempts"
            echo "This may be normal for initial deployments. Please verify manually."
          fi

  # Deploy to Production Environment
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [ deploy-staging ]
    if: env.DEPLOY_ENV == 'production' || env.DEPLOY_ENV == 'both'
    environment:
      name: production
      url: https://mycats-pro-frontend-518939509282.asia-northeast1.run.app
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate required secrets
        run: |
          if [ -z "${{ secrets.GCP_SA_KEY }}" ]; then
            echo "‚ùå Error: GCP_SA_KEY secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.GCP_PROJECT_ID }}" ]; then
            echo "‚ùå Error: GCP_PROJECT_ID secret is not set"
            exit 1
          fi
          echo "‚úÖ All required secrets are configured"

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker asia-northeast1-docker.pkg.dev

      - name: Deploy to Production using Cloud Build
        run: |
          echo "üöÄ Deploying to production environment..."
          gcloud builds submit \
            --config=cloudbuild.yaml \
            --substitutions=_BACKEND_SERVICE_NAME=mycats-pro-backend,_FRONTEND_SERVICE_NAME=mycats-pro-frontend,_ENVIRONMENT=production,_CLOUD_SQL_CONNECTION_NAME=my-cats-pro:asia-northeast1:mycats-prod-db,_CORS_ORIGIN=https://mycats-pro-frontend-518939509282.asia-northeast1.run.app,_NEXT_PUBLIC_API_URL=https://mycats-pro-backend-518939509282.asia-northeast1.run.app/api/v1,_DATABASE_URL_SECRET_NAME=DATABASE_URL,_DATABASE_URL_SECRET_VERSION=1,_JWT_SECRET_NAME=JWT_SECRET,_JWT_SECRET_VERSION=1,_JWT_REFRESH_SECRET_NAME=JWT_REFRESH_SECRET,_JWT_REFRESH_SECRET_VERSION=1,_CSRF_TOKEN_SECRET_NAME=CSRF_TOKEN_SECRET,_CSRF_TOKEN_SECRET_VERSION=1 \
            --project=${{ secrets.GCP_PROJECT_ID }}

      - name: Verify Production Deployment
        run: |
          echo "‚úÖ Production deployment completed"
          echo "Backend URL: https://mycats-pro-backend-518939509282.asia-northeast1.run.app"
          echo "Frontend URL: https://mycats-pro-frontend-518939509282.asia-northeast1.run.app"

      - name: Test Production Health Endpoint
        run: |
          echo "üè• Testing production backend health endpoint..."
          sleep 30
          max_attempts=10
          attempt=0
          while [ $attempt -lt $max_attempts ]; do
            response=$(curl -s -o /dev/null -w "%{http_code}" https://mycats-pro-backend-518939509282.asia-northeast1.run.app/health || echo "000")
            if [ "$response" = "200" ]; then
              echo "‚úÖ Production backend is healthy (HTTP 200)"
              break
            fi
            attempt=$((attempt + 1))
            echo "‚è≥ Waiting for production backend to be ready... (attempt $attempt/$max_attempts, got HTTP $response)"
            sleep 10
          done
          if [ $attempt -eq $max_attempts ]; then
            echo "‚ö†Ô∏è Warning: Production backend did not respond with HTTP 200 after $max_attempts attempts"
            echo "This may be normal for initial deployments. Please verify manually."
          fi
