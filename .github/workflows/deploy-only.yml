name: Deploy Only (Staging & Production)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - staging
          - production
          - both
  workflow_call:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: string
    secrets:
      # Staging secrets
      GCP_SA_KEY_STAGING:
        required: false
      GCP_PROJECT_ID_STAGING:
        required: false
      GCP_SQL_INSTANCE_NAME_STAGING:
        required: false
      GCP_RUN_SA_BACKEND_STAGING:
        required: false
      GCP_RUN_SA_FRONTEND_STAGING:
        required: false
      # Production secrets
      GCP_SA_KEY:
        required: false
      GCP_PROJECT_ID:
        required: false
      GCP_SQL_INSTANCE_NAME:
        required: false
      GCP_RUN_SA_BACKEND:
        required: false
      GCP_RUN_SA_FRONTEND:
        required: false

permissions:
  contents: read

env:
  NODE_VERSION: "20"
  PNPM_VERSION: "9"
  REGION: "asia-northeast1"
  REPO_NAME: "mycats-pro"

jobs:
  # Deploy to Staging Environment (mycats-pro-staging project)
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    if: inputs.environment == 'staging' || inputs.environment == 'both'
    environment:
      name: staging
      url: https://mycats-pro-backend-staging.asia-northeast1.run.app
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate required secrets for Staging
        run: |
          missing_secrets=()
          
          if [ -z "${{ secrets.GCP_SA_KEY_STAGING }}" ]; then
            missing_secrets+=("GCP_SA_KEY_STAGING")
          fi
          if [ -z "${{ secrets.GCP_PROJECT_ID_STAGING }}" ]; then
            missing_secrets+=("GCP_PROJECT_ID_STAGING")
          fi
          if [ -z "${{ secrets.GCP_SQL_INSTANCE_NAME_STAGING }}" ]; then
            missing_secrets+=("GCP_SQL_INSTANCE_NAME_STAGING")
          fi
          if [ -z "${{ secrets.GCP_RUN_SA_BACKEND_STAGING }}" ]; then
            missing_secrets+=("GCP_RUN_SA_BACKEND_STAGING")
          fi
          if [ -z "${{ secrets.GCP_RUN_SA_FRONTEND_STAGING }}" ]; then
            missing_secrets+=("GCP_RUN_SA_FRONTEND_STAGING")
          fi
          
          if [ ${#missing_secrets[@]} -gt 0 ]; then
            echo "‚ùå Error: The following secrets are not set:"
            for secret in "${missing_secrets[@]}"; do
              echo "  - $secret"
            done
            echo ""
            echo "Please configure these secrets in repository settings:"
            echo "  Settings > Secrets and variables > Actions > New repository secret"
            exit 1
          fi
          
          echo "‚úÖ All required staging secrets are configured"

      - name: Authenticate to Google Cloud (Staging)
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_STAGING }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID_STAGING }}

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

      - name: Deploy to Staging using Cloud Build
        env:
          PROJECT_ID: ${{ secrets.GCP_PROJECT_ID_STAGING }}
          SQL_INSTANCE: ${{ secrets.GCP_SQL_INSTANCE_NAME_STAGING }}
          BACKEND_SA: ${{ secrets.GCP_RUN_SA_BACKEND_STAGING }}
          FRONTEND_SA: ${{ secrets.GCP_RUN_SA_FRONTEND_STAGING }}
        run: |
          echo "üöÄ Deploying to staging environment..."
          echo "   Project: ${PROJECT_ID}"
          echo "   SQL Instance: ${SQL_INSTANCE}"
          
          # Validate that required environment variables are set
          if [ -z "${FRONTEND_SA}" ]; then
            echo "‚ùå Error: FRONTEND_SA is not set or empty"
            echo "   This means GCP_RUN_SA_FRONTEND_STAGING secret is missing or empty"
            exit 1
          fi
          
          if [ -z "${BACKEND_SA}" ]; then
            echo "‚ùå Error: BACKEND_SA is not set or empty"
            echo "   This means GCP_RUN_SA_BACKEND_STAGING secret is missing or empty"
            exit 1
          fi
          
          echo "   Backend Service Account: ${BACKEND_SA}"
          echo "   Frontend Service Account: ${FRONTEND_SA}"
          
          # Build Cloud SQL connection name
          CLOUD_SQL_CONN="${PROJECT_ID}:${{ env.REGION }}:${SQL_INSTANCE}"
          
          # Build service URLs (will be updated after first deployment)
          BACKEND_URL="https://mycats-pro-backend-staging-687406216678.${{ env.REGION }}.run.app"
          FRONTEND_URL="https://mycats-pro-frontend-staging-687406216678.${{ env.REGION }}.run.app"
          
          # Get actual Cloud Run frontend URL for CORS
          CLOUD_RUN_FRONTEND_URL=$(gcloud run services describe mycats-pro-frontend-staging \
            --region=${{ env.REGION }} \
            --project="${PROJECT_ID}" \
            --format='value(status.url)' 2>/dev/null || echo "")
          
          # CORS_ORIGIN„Å´Êó¢ÂÆöURL„Å®Cloud Run URL„ÅÆ‰∏°Êñπ„ÇíÂê´„ÇÅ„Çã
          # Ê≥®ÊÑè: gcloud --substitutions„Åß„ÅØÂÄ§„Å´„Ç´„É≥„Éû„ÇíÂê´„ÇÅ„Çâ„Çå„Å™„ÅÑ„Åü„ÇÅ„ÄÅ
          # ‰∏ÄÊôÇÁöÑ„Å´„Éë„Ç§„ÉóÊñáÂ≠ó(|)„ÇíÂå∫Âàá„ÇäÊñáÂ≠ó„Å®„Åó„Å¶‰ΩøÁî®„Åó„ÄÅcloudbuild.yamlÂÅ¥„Åß„Ç´„É≥„Éû„Å´Â§âÊèõ„Åô„Çã
          if [ -n "${CLOUD_RUN_FRONTEND_URL}" ]; then
            CORS_ORIGIN="${FRONTEND_URL}|${CLOUD_RUN_FRONTEND_URL}"
          else
            CORS_ORIGIN="${FRONTEND_URL}"
          fi
          
          # Build substitutions string
          # Note: „Éë„Ç§„ÉóÊñáÂ≠ó„ÅßÂå∫Âàá„Çâ„Çå„ÅüCORS_ORIGIN„ÅØcloudbuild.yaml„Åß„Ç´„É≥„Éû„Å´Â§âÊèõ„Åï„Çå„Çã
          SUBSTITUTIONS="_ENVIRONMENT=staging"
          SUBSTITUTIONS="${SUBSTITUTIONS},_REPO_NAME=${{ env.REPO_NAME }}"
          SUBSTITUTIONS="${SUBSTITUTIONS},_BACKEND_SERVICE_NAME=mycats-pro-backend-staging"
          SUBSTITUTIONS="${SUBSTITUTIONS},_FRONTEND_SERVICE_NAME=mycats-pro-frontend-staging"
          SUBSTITUTIONS="${SUBSTITUTIONS},_CLOUD_SQL_CONNECTION_NAME=${CLOUD_SQL_CONN}"
          SUBSTITUTIONS="${SUBSTITUTIONS},_BACKEND_SERVICE_ACCOUNT=${BACKEND_SA}"
          SUBSTITUTIONS="${SUBSTITUTIONS},_FRONTEND_SERVICE_ACCOUNT=${FRONTEND_SA}"
          SUBSTITUTIONS="${SUBSTITUTIONS},_CORS_ORIGIN=${CORS_ORIGIN}"
          SUBSTITUTIONS="${SUBSTITUTIONS},_NEXT_PUBLIC_API_URL=${BACKEND_URL}/api/v1"
          SUBSTITUTIONS="${SUBSTITUTIONS},_DATABASE_URL_SECRET_NAME=DATABASE_URL"
          SUBSTITUTIONS="${SUBSTITUTIONS},_DATABASE_URL_SECRET_VERSION=latest"
          SUBSTITUTIONS="${SUBSTITUTIONS},_DIRECT_URL_SECRET_NAME=DIRECT_URL"
          SUBSTITUTIONS="${SUBSTITUTIONS},_DIRECT_URL_SECRET_VERSION=latest"
          SUBSTITUTIONS="${SUBSTITUTIONS},_JWT_SECRET_NAME=JWT_SECRET"
          SUBSTITUTIONS="${SUBSTITUTIONS},_JWT_SECRET_VERSION=latest"
          SUBSTITUTIONS="${SUBSTITUTIONS},_JWT_REFRESH_SECRET_NAME=JWT_REFRESH_SECRET"
          SUBSTITUTIONS="${SUBSTITUTIONS},_JWT_REFRESH_SECRET_VERSION=latest"
          SUBSTITUTIONS="${SUBSTITUTIONS},_CSRF_TOKEN_SECRET_NAME=CSRF_TOKEN_SECRET"
          SUBSTITUTIONS="${SUBSTITUTIONS},_CSRF_TOKEN_SECRET_VERSION=latest"
          SUBSTITUTIONS="${SUBSTITUTIONS},_RESEND_API_KEY_SECRET_NAME=RESEND_API_KEY"
          SUBSTITUTIONS="${SUBSTITUTIONS},_RESEND_API_KEY_SECRET_VERSION=latest"
          SUBSTITUTIONS="${SUBSTITUTIONS},_EMAIL_FROM=noreply@nekoya.co.jp"
          SUBSTITUTIONS="${SUBSTITUTIONS},_EMAIL_FROM_NAME=MyCats Pro"
          
          echo "üìã Substitutions being passed to Cloud Build:"
          echo "${SUBSTITUTIONS}" | tr ',' '\n' | sed 's/^/  /'
          
          gcloud builds submit \
            --config=cloudbuild.yaml \
            --substitutions="${SUBSTITUTIONS}" \
            --project="${PROJECT_ID}"

      - name: Verify Staging Deployment
        env:
          PROJECT_ID: ${{ secrets.GCP_PROJECT_ID_STAGING }}
        run: |
          echo "‚úÖ Staging deployment completed"
          
          # Get actual service URLs
          BACKEND_URL=$(gcloud run services describe mycats-pro-backend-staging \
            --region=${{ env.REGION }} \
            --project="${PROJECT_ID}" \
            --format='value(status.url)' 2>/dev/null || echo "Not available yet")
          
          FRONTEND_URL=$(gcloud run services describe mycats-pro-frontend-staging \
            --region=${{ env.REGION }} \
            --project="${PROJECT_ID}" \
            --format='value(status.url)' 2>/dev/null || echo "Not available yet")
          
          echo "Backend URL: ${BACKEND_URL}"
          echo "Frontend URL: ${FRONTEND_URL}"

      - name: Test Staging Health Endpoint
        env:
          PROJECT_ID: ${{ secrets.GCP_PROJECT_ID_STAGING }}
        run: |
          echo "üè• Testing staging backend health endpoint..."
          
          BACKEND_URL=$(gcloud run services describe mycats-pro-backend-staging \
            --region=${{ env.REGION }} \
            --project="${PROJECT_ID}" \
            --format='value(status.url)' 2>/dev/null || echo "")
          
          if [ -z "${BACKEND_URL}" ]; then
            echo "‚ö†Ô∏è Could not retrieve backend URL, skipping health check"
            exit 0
          fi
          
          sleep 30
          max_attempts=10
          attempt=0
          while [ $attempt -lt $max_attempts ]; do
            response=$(curl -s -o /dev/null -w "%{http_code}" "${BACKEND_URL}/health" || echo "000")
            if [ "$response" = "200" ]; then
              echo "‚úÖ Staging backend is healthy (HTTP 200)"
              break
            fi
            attempt=$((attempt + 1))
            echo "‚è≥ Waiting for staging backend to be ready... (attempt $attempt/$max_attempts, got HTTP $response)"
            sleep 10
          done
          if [ $attempt -eq $max_attempts ]; then
            echo "‚ö†Ô∏è Warning: Staging backend did not respond with HTTP 200 after $max_attempts attempts"
            echo "This may be normal for initial deployments. Please verify manually."
          fi

  # Deploy to Production Environment (mycats-pro project)
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [deploy-staging]
    if: |
      always() &&
      (needs.deploy-staging.result == 'success' || needs.deploy-staging.result == 'skipped') &&
      (inputs.environment == 'production' || inputs.environment == 'both')
    environment:
      name: production
      url: https://mycats-pro-backend.asia-northeast1.run.app
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate required secrets for Production
        run: |
          missing_secrets=()
          
          if [ -z "${{ secrets.GCP_SA_KEY }}" ]; then
            missing_secrets+=("GCP_SA_KEY")
          fi
          if [ -z "${{ secrets.GCP_PROJECT_ID }}" ]; then
            missing_secrets+=("GCP_PROJECT_ID")
          fi
          if [ -z "${{ secrets.GCP_SQL_INSTANCE_NAME }}" ]; then
            missing_secrets+=("GCP_SQL_INSTANCE_NAME")
          fi
          if [ -z "${{ secrets.GCP_RUN_SA_BACKEND }}" ]; then
            missing_secrets+=("GCP_RUN_SA_BACKEND")
          fi
          if [ -z "${{ secrets.GCP_RUN_SA_FRONTEND }}" ]; then
            missing_secrets+=("GCP_RUN_SA_FRONTEND")
          fi
          
          if [ ${#missing_secrets[@]} -gt 0 ]; then
            echo "‚ùå Error: The following secrets are not set:"
            for secret in "${missing_secrets[@]}"; do
              echo "  - $secret"
            done
            echo ""
            echo "Please configure these secrets in repository settings:"
            echo "  Settings > Secrets and variables > Actions > New repository secret"
            exit 1
          fi
          
          echo "‚úÖ All required production secrets are configured"

      - name: Authenticate to Google Cloud (Production)
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

      - name: Deploy to Production using Cloud Build
        env:
          PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          SQL_INSTANCE: ${{ secrets.GCP_SQL_INSTANCE_NAME }}
          BACKEND_SA: ${{ secrets.GCP_RUN_SA_BACKEND }}
          FRONTEND_SA: ${{ secrets.GCP_RUN_SA_FRONTEND }}
        run: |
          echo "üöÄ Deploying to production environment..."
          echo "   Project: ${PROJECT_ID}"
          echo "   SQL Instance: ${SQL_INSTANCE}"
          
          # Validate that required environment variables are set
          if [ -z "${FRONTEND_SA}" ]; then
            echo "‚ùå Error: FRONTEND_SA is not set or empty"
            echo "   This means GCP_RUN_SA_FRONTEND secret is missing or empty"
            exit 1
          fi
          
          if [ -z "${BACKEND_SA}" ]; then
            echo "‚ùå Error: BACKEND_SA is not set or empty"
            echo "   This means GCP_RUN_SA_BACKEND secret is missing or empty"
            exit 1
          fi
          
          echo "   Backend Service Account: ${BACKEND_SA}"
          echo "   Frontend Service Account: ${FRONTEND_SA}"
          
          # Build Cloud SQL connection name
          CLOUD_SQL_CONN="${PROJECT_ID}:${{ env.REGION }}:${SQL_INSTANCE}"
          
          # Production URLs - Áã¨Ëá™„Éâ„É°„Ç§„É≥„Çí‰ΩøÁî®
          BACKEND_URL="https://api.nekoya.co.jp"
          FRONTEND_URL="https://nekoya.co.jp"
          
          # Get actual Cloud Run frontend URL for CORS
          CLOUD_RUN_FRONTEND_URL=$(gcloud run services describe mycats-pro-frontend \
            --region=${{ env.REGION }} \
            --project="${PROJECT_ID}" \
            --format='value(status.url)' 2>/dev/null || echo "")
          
          # CORS_ORIGIN„Å´Áã¨Ëá™„Éâ„É°„Ç§„É≥„Å®Cloud Run URL„ÅÆ‰∏°Êñπ„ÇíÂê´„ÇÅ„Çã
          # Ê≥®ÊÑè: gcloud --substitutions„Åß„ÅØÂÄ§„Å´„Ç´„É≥„Éû„ÇíÂê´„ÇÅ„Çâ„Çå„Å™„ÅÑ„Åü„ÇÅ„ÄÅ
          # ‰∏ÄÊôÇÁöÑ„Å´„Éë„Ç§„ÉóÊñáÂ≠ó(|)„ÇíÂå∫Âàá„ÇäÊñáÂ≠ó„Å®„Åó„Å¶‰ΩøÁî®„Åó„ÄÅcloudbuild.yamlÂÅ¥„Åß„Ç´„É≥„Éû„Å´Â§âÊèõ„Åô„Çã
          if [ -n "${CLOUD_RUN_FRONTEND_URL}" ]; then
            CORS_ORIGIN="${FRONTEND_URL}|https://www.nekoya.co.jp|${CLOUD_RUN_FRONTEND_URL}"
          else
            CORS_ORIGIN="${FRONTEND_URL}|https://www.nekoya.co.jp"
          fi
          
          # Build substitutions string
          # Note: „Éë„Ç§„ÉóÊñáÂ≠ó„ÅßÂå∫Âàá„Çâ„Çå„ÅüCORS_ORIGIN„ÅØcloudbuild.yaml„Åß„Ç´„É≥„Éû„Å´Â§âÊèõ„Åï„Çå„Çã
          SUBSTITUTIONS="_ENVIRONMENT=production"
          SUBSTITUTIONS="${SUBSTITUTIONS},_REPO_NAME=${{ env.REPO_NAME }}"
          SUBSTITUTIONS="${SUBSTITUTIONS},_BACKEND_SERVICE_NAME=mycats-pro-backend"
          SUBSTITUTIONS="${SUBSTITUTIONS},_FRONTEND_SERVICE_NAME=mycats-pro-frontend"
          SUBSTITUTIONS="${SUBSTITUTIONS},_CLOUD_SQL_CONNECTION_NAME=${CLOUD_SQL_CONN}"
          SUBSTITUTIONS="${SUBSTITUTIONS},_BACKEND_SERVICE_ACCOUNT=${BACKEND_SA}"
          SUBSTITUTIONS="${SUBSTITUTIONS},_FRONTEND_SERVICE_ACCOUNT=${FRONTEND_SA}"
          SUBSTITUTIONS="${SUBSTITUTIONS},_CORS_ORIGIN=${CORS_ORIGIN}"
          SUBSTITUTIONS="${SUBSTITUTIONS},_NEXT_PUBLIC_API_URL=${BACKEND_URL}/api/v1"
          SUBSTITUTIONS="${SUBSTITUTIONS},_DATABASE_URL_SECRET_NAME=DATABASE_URL"
          SUBSTITUTIONS="${SUBSTITUTIONS},_DATABASE_URL_SECRET_VERSION=latest"
          SUBSTITUTIONS="${SUBSTITUTIONS},_DIRECT_URL_SECRET_NAME=DIRECT_URL"
          SUBSTITUTIONS="${SUBSTITUTIONS},_DIRECT_URL_SECRET_VERSION=latest"
          SUBSTITUTIONS="${SUBSTITUTIONS},_JWT_SECRET_NAME=JWT_SECRET"
          SUBSTITUTIONS="${SUBSTITUTIONS},_JWT_SECRET_VERSION=latest"
          SUBSTITUTIONS="${SUBSTITUTIONS},_JWT_REFRESH_SECRET_NAME=JWT_REFRESH_SECRET"
          SUBSTITUTIONS="${SUBSTITUTIONS},_JWT_REFRESH_SECRET_VERSION=latest"
          SUBSTITUTIONS="${SUBSTITUTIONS},_CSRF_TOKEN_SECRET_NAME=CSRF_TOKEN_SECRET"
          SUBSTITUTIONS="${SUBSTITUTIONS},_CSRF_TOKEN_SECRET_VERSION=latest"
          SUBSTITUTIONS="${SUBSTITUTIONS},_RESEND_API_KEY_SECRET_NAME=RESEND_API_KEY"
          SUBSTITUTIONS="${SUBSTITUTIONS},_RESEND_API_KEY_SECRET_VERSION=latest"
          SUBSTITUTIONS="${SUBSTITUTIONS},_EMAIL_FROM=noreply@nekoya.co.jp"
          SUBSTITUTIONS="${SUBSTITUTIONS},_EMAIL_FROM_NAME=MyCats Pro"
          
          echo "üìã Substitutions being passed to Cloud Build:"
          echo "${SUBSTITUTIONS}" | tr ',' '\n' | sed 's/^/  /'
          
          gcloud builds submit \
            --config=cloudbuild.yaml \
            --substitutions="${SUBSTITUTIONS}" \
            --project="${PROJECT_ID}"

      - name: Verify Production Deployment
        env:
          PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
        run: |
          echo "‚úÖ Production deployment completed"
          
          # Get actual service URLs
          BACKEND_URL=$(gcloud run services describe mycats-pro-backend \
            --region=${{ env.REGION }} \
            --project="${PROJECT_ID}" \
            --format='value(status.url)' 2>/dev/null || echo "Not available yet")
          
          FRONTEND_URL=$(gcloud run services describe mycats-pro-frontend \
            --region=${{ env.REGION }} \
            --project="${PROJECT_ID}" \
            --format='value(status.url)' 2>/dev/null || echo "Not available yet")
          
          echo "Backend URL: ${BACKEND_URL}"
          echo "Frontend URL: ${FRONTEND_URL}"

      - name: Test Production Health Endpoint
        env:
          PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
        run: |
          echo "üè• Testing production backend health endpoint..."
          
          BACKEND_URL=$(gcloud run services describe mycats-pro-backend \
            --region=${{ env.REGION }} \
            --project="${PROJECT_ID}" \
            --format='value(status.url)' 2>/dev/null || echo "")
          
          if [ -z "${BACKEND_URL}" ]; then
            echo "‚ö†Ô∏è Could not retrieve backend URL, skipping health check"
            exit 0
          fi
          
          sleep 30
          max_attempts=10
          attempt=0
          while [ $attempt -lt $max_attempts ]; do
            response=$(curl -s -o /dev/null -w "%{http_code}" "${BACKEND_URL}/health" || echo "000")
            if [ "$response" = "200" ]; then
              echo "‚úÖ Production backend is healthy (HTTP 200)"
              break
            fi
            attempt=$((attempt + 1))
            echo "‚è≥ Waiting for production backend to be ready... (attempt $attempt/$max_attempts, got HTTP $response)"
            sleep 10
          done
          if [ $attempt -eq $max_attempts ]; then
            echo "‚ö†Ô∏è Warning: Production backend did not respond with HTTP 200 after $max_attempts attempts"
            echo "This may be normal for initial deployments. Please verify manually."
          fi
