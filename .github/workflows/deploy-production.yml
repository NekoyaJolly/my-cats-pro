name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

env:
  PROJECT_ID: my-cats-pro
  REGION: asia-northeast1
  REPO_NAME: mycats-pro

jobs:
  # ã‚¹ãƒ†ãƒ¼ã‚¸1: é™çš„ãƒã‚§ãƒƒã‚¯ãƒ»ãƒ†ã‚¹ãƒˆ
  validate:
    name: Validate & Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install

      - name: Check Prisma configuration
        run: |
          echo "Checking if prisma is in dependencies..."
          if ! grep -A 20 '"dependencies"' backend/package.json | grep -q '"prisma"'; then
            echo "âŒ Error: prisma must be in dependencies, not devDependencies"
            exit 1
          fi
          echo "âœ… Prisma is correctly in dependencies"

      - name: Validate Prisma schema
        run: |
          cd backend
          pnpm prisma validate

      - name: Check for reserved environment variables
        run: |
          echo "Checking cloudbuild.yaml for reserved env vars..."
          if grep -q 'PORT=' cloudbuild.yaml; then
            echo "âŒ Error: PORT environment variable is reserved by Cloud Run"
            exit 1
          fi
          echo "âœ… No reserved environment variables found"

      - name: Lint backend
        run: pnpm --filter backend run lint
        continue-on-error: true

      - name: Type check backend
        run: pnpm --filter backend run type-check

      - name: Build backend (dry run)
        run: pnpm --filter backend run build

      - name: Build frontend (dry run)
        run: pnpm --filter frontend run build
        env:
          NEXT_PUBLIC_API_URL: https://example.com/api/v1

  # ã‚¹ãƒ†ãƒ¼ã‚¸2: Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆ
  docker-build-test:
    name: Docker Build Test
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Test build backend image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.backend
          push: false
          tags: backend:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Test build frontend image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.frontend
          push: false
          tags: frontend:test
          build-args: |
            NEXT_PUBLIC_API_URL=https://example.com/api/v1
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Verify Prisma files in backend image
        run: |
          docker build -f Dockerfile.backend -t backend-verify .
          echo "Checking for Prisma CLI..."
          docker run --rm backend-verify which prisma || echo "Warning: prisma CLI not found in PATH"
          echo "Checking for prisma directory..."
          docker run --rm backend-verify ls -la prisma/
          echo "Checking for migrations..."
          docker run --rm backend-verify ls -la prisma/migrations/ || echo "No migrations found"

  # ã‚¹ãƒ†ãƒ¼ã‚¸3: Cloud Buildã§ãƒ‡ãƒ—ãƒ­ã‚¤
  deploy:
    name: Deploy to Cloud Run
    runs-on: ubuntu-latest
    needs: docker-build-test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Submit to Cloud Build
        run: |
          gcloud builds submit \
            --config cloudbuild.yaml \
            --project ${{ env.PROJECT_ID }} \
            .

      - name: Get service URLs
        id: get-urls
        run: |
          BACKEND_URL=$(gcloud run services describe mycats-pro-backend \
            --region ${{ env.REGION }} \
            --format 'value(status.url)')
          FRONTEND_URL=$(gcloud run services describe mycats-pro-frontend \
            --region ${{ env.REGION }} \
            --format 'value(status.url)')
          
          echo "backend_url=$BACKEND_URL" >> $GITHUB_OUTPUT
          echo "frontend_url=$FRONTEND_URL" >> $GITHUB_OUTPUT
          
          echo "ðŸš€ Backend deployed to: $BACKEND_URL"
          echo "ðŸŒ Frontend deployed to: $FRONTEND_URL"

      - name: Health check
        run: |
          echo "Waiting for services to be ready..."
          sleep 30
          
          # Backend health check
          BACKEND_STATUS=$(curl -s -o /dev/null -w "%{http_code}" ${{ steps.get-urls.outputs.backend_url }}/health || echo "000")
          if [ "$BACKEND_STATUS" = "200" ]; then
            echo "âœ… Backend health check passed"
          else
            echo "âš ï¸ Backend health check returned status: $BACKEND_STATUS"
          fi
          
          # Frontend health check
          FRONTEND_STATUS=$(curl -s -o /dev/null -w "%{http_code}" ${{ steps.get-urls.outputs.frontend_url }} || echo "000")
          if [ "$FRONTEND_STATUS" = "200" ]; then
            echo "âœ… Frontend health check passed"
          else
            echo "âš ï¸ Frontend health check returned status: $FRONTEND_STATUS"
          fi

      - name: Create deployment summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          # ðŸš€ Deployment Summary
          
          ## Services Deployed
          
          - **Backend**: ${{ steps.get-urls.outputs.backend_url }}
          - **Frontend**: ${{ steps.get-urls.outputs.frontend_url }}
          
          ## Next Steps
          
          1. Update \`cloudbuild.yaml\` with the actual service URLs if this is the first deployment
          2. Test the application endpoints
          3. Check Cloud Run logs for any issues
          
          ## Useful Commands
          
          \`\`\`bash
          # View backend logs
          gcloud run services logs read mycats-pro-backend --region asia-northeast1 --limit 50
          
          # View frontend logs
          gcloud run services logs read mycats-pro-frontend --region asia-northeast1 --limit 50
          \`\`\`
          EOF
