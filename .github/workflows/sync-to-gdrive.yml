name: Sync to Google Drive (rclone)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  sync-to-drive:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install repomix
        run: npm install -g repomix

      - name: Create domain files (NotebookLM Ready)
        run: |
          mkdir -p dist_notebook
          
          # 1. çŒ«ç®¡ç†
          npx repomix \
            --include "backend/prisma/schema.prisma,backend/src/cats/**,backend/src/breeds/**,backend/src/coat-colors/**,backend/src/gallery/**,backend/src/gallery-upload/**,frontend/src/app/cats/**,frontend/src/app/gallery/**,frontend/src/components/cats/**" \
            --output dist_notebook/Domain_Cats.md \
            --style markdown
          echo "# Domain: çŒ«ç®¡ç† (Cat Management)" | cat - dist_notebook/Domain_Cats.md > tmp && mv tmp dist_notebook/Domain_Cats.md

          # 2. ç¹æ®–ç®¡ç†
          npx repomix \
            --include "backend/prisma/schema.prisma,backend/src/breeding/**,backend/src/graduation/**,frontend/src/app/breeding/**,frontend/src/app/kittens/**" \
            --output dist_notebook/Domain_Breeding.md \
            --style markdown
          echo "# Domain: ç¹æ®–ç®¡ç† (Breeding Management)" | cat - dist_notebook/Domain_Breeding.md > tmp && mv tmp dist_notebook/Domain_Breeding.md

          # 3. è¡€çµ±æ›¸
          npx repomix \
            --include "backend/prisma/schema.prisma,backend/src/pedigree/**,frontend/src/app/pedigrees/**" \
            --output dist_notebook/Domain_Pedigree.md \
            --style markdown
          echo "# Domain: è¡€çµ±æ›¸ (Pedigree)" | cat - dist_notebook/Domain_Pedigree.md > tmp && mv tmp dist_notebook/Domain_Pedigree.md

          # 4. ã‚±ã‚¢ãƒ»åŒ»ç™‚
          npx repomix \
            --include "backend/prisma/schema.prisma,backend/src/care/**,frontend/src/app/care/**,frontend/src/app/medical-records/**" \
            --output dist_notebook/Domain_Care.md \
            --style markdown
          echo "# Domain: ã‚±ã‚¢ãƒ»åŒ»ç™‚ (Care & Medical)" | cat - dist_notebook/Domain_Care.md > tmp && mv tmp dist_notebook/Domain_Care.md

          # 5. ã‚·ã‚¹ãƒ†ãƒ è¨­å®š
          npx repomix \
            --include "backend/prisma/schema.prisma,backend/src/tags/**,backend/src/tenants/**,backend/src/users/**,backend/src/auth/**,backend/src/shift/**,backend/src/staff/**,frontend/src/app/tags/**,frontend/src/app/tenants/**,frontend/src/app/settings/**,frontend/src/app/staff/**" \
            --output dist_notebook/Domain_Settings.md \
            --style markdown
          echo "# Domain: ã‚·ã‚¹ãƒ†ãƒ è¨­å®š (System Settings)" | cat - dist_notebook/Domain_Settings.md > tmp && mv tmp dist_notebook/Domain_Settings.md

          # 6. å…±é€šã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
          npx repomix \
            --include "backend/src/common/**,frontend/src/components/**,frontend/src/lib/**" \
            --output dist_notebook/Domain_Common.md \
            --style markdown
          echo "# Domain: å…±é€šã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ (Common)" | cat - dist_notebook/Domain_Common.md > tmp && mv tmp dist_notebook/Domain_Common.md

          # 7. DBã‚¹ã‚­ãƒ¼ãƒå˜ç‹¬
          npx repomix \
            --include "backend/prisma/schema.prisma,backend/prisma/migrations/**/*.sql" \
            --output dist_notebook/Schema_Database.md \
            --style markdown
          echo "# Database Schema (Prisma)" | cat - dist_notebook/Schema_Database.md > tmp && mv tmp dist_notebook/Schema_Database.md

          echo "âœ… Domain files generated:"
          ls -lh dist_notebook/

      - name: Setup rclone
        uses: rclone/rclone-action@v1
        with:
          rclone_version: 'latest'

      - name: Sync to Google Drive
        env:
          RCLONE_CONF: ${{ secrets.RCLONE_CONF }}
          GOOGLE_DRIVE_FOLDER_ID: ${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}
        run: |
          # rclone.confã‚’ä½œæˆ
          mkdir -p ~/.config/rclone
          echo "$RCLONE_CONF" | base64 --decode > ~/.config/rclone/rclone.conf
          
          # rclone configã®ä¸­èº«ã‚’å‹•çš„ã«æ›¸ãæ›ãˆã‚‹ï¼ˆFolder IDãªã©ï¼‰
          # æ³¨: RCLONE_CONFã«ã¯ [gdrive] ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒå«ã¾ã‚Œã¦ã„ã‚‹å‰æ
          
          echo "ğŸš€ Starting sync to folder ID: $GOOGLE_DRIVE_FOLDER_ID"
          
          # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰è¨­å®š: gdrive
          # root_folder_id ã‚’å‹•çš„ã«è¨­å®šã™ã‚‹ãŸã‚ã«ç’°å¢ƒå¤‰æ•°çµŒç”±ã¾ãŸã¯å¼•æ•°ã§æ¸¡ã™ã®ãŒä¸€èˆ¬çš„ã ãŒ
          # rclone backend support allows overriding
          
          # --drive-root-folder-id ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨
          
          rclone sync dist_notebook gdrive: \
            --drive-root-folder-id "$GOOGLE_DRIVE_FOLDER_ID" \
            --checksum \
            --delete-excluded \
            --transfers=8 \
            --verbose
            
          echo "ğŸ‰ Sync complete!"
