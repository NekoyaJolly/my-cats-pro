name: Sync Files to Google Drive

on:
  push:
    branches:
      - main
  workflow_dispatch:  # ÊâãÂãïÂÆüË°åÂèØËÉΩ

jobs:
  sync-to-drive:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Get changed files
        id: changed-files
        run: |
          # ÂàùÂõûÂÆüË°å„Åæ„Åü„ÅØÊâãÂãïÂÆüË°å„ÅÆÂ†¥Âêà„ÅØÂÖ®„Éï„Ç°„Ç§„É´„ÇíÂØæË±°
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "Manual trigger - syncing all files"
            find . -type f \
              ! -path './.git/*' \
              ! -path './node_modules/*' \
              ! -path './.next/*' \
              ! -path './dist/*' \
              ! -path './build/*' \
              ! -path './.env*' \
              ! -name '*.log' \
              ! -name '*.lock' \
              ! -name 'pnpm-lock.yaml' \
              ! -name 'package-lock.json' \
              | sed 's|^\./||' > files_to_sync.txt
          else
            # ÈÄöÂ∏∏„ÅÆ„Éó„ÉÉ„Ç∑„É• - Â§âÊõ¥„Éï„Ç°„Ç§„É´„ÅÆ„Åø
            git diff --name-only HEAD^ HEAD 2>/dev/null > files_to_sync.txt || \
            find . -type f \
              ! -path './.git/*' \
              ! -path './node_modules/*' \
              ! -path './.next/*' \
              ! -path './dist/*' \
              ! -path './build/*' \
              ! -path './.env*' \
              ! -name '*.log' \
              ! -name '*.lock' \
              ! -name 'pnpm-lock.yaml' \
              ! -name 'package-lock.json' \
              | sed 's|^\./||' > files_to_sync.txt
          fi
          
          # Â≠òÂú®„Åô„Çã„Éï„Ç°„Ç§„É´„ÅÆ„Åø„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
          tmp_file=$(mktemp)
          while read -r file; do
            if [ -f "$file" ]; then
              echo "$file" >> "$tmp_file"
            fi
          done < files_to_sync.txt
          mv "$tmp_file" files_to_sync.txt
          
          file_count=$(wc -l < files_to_sync.txt | tr -d ' ')
          echo "count=$file_count" >> $GITHUB_OUTPUT
          
          echo "Files to sync: $file_count"
          head -20 files_to_sync.txt

      - name: Setup Python
        if: steps.changed-files.outputs.count > 0
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Google API dependencies
        if: steps.changed-files.outputs.count > 0
        run: |
          pip install --upgrade pip
          pip install google-auth google-api-python-client

      - name: Setup Google Drive credentials
        if: steps.changed-files.outputs.count > 0
        run: |
          echo '${{ secrets.GOOGLE_DRIVE_CREDENTIALS }}' > credentials.json

      - name: Sync files to Google Drive
        if: steps.changed-files.outputs.count > 0
        env:
          GOOGLE_DRIVE_FOLDER_ID: ${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}
        run: |
          python << 'EOF'
          import os
          import json
          from google.oauth2 import service_account
          from googleapiclient.discovery import build
          from googleapiclient.http import MediaFileUpload

          SCOPES = ['https://www.googleapis.com/auth/drive.file']

          # Ë™çË®º
          credentials = service_account.Credentials.from_service_account_file(
              'credentials.json', scopes=SCOPES)
          service = build('drive', 'v3', credentials=credentials)

          ROOT_FOLDER_ID = os.environ.get('GOOGLE_DRIVE_FOLDER_ID', '')

          # MIME„Çø„Ç§„Éó„Éû„ÉÉ„Éî„É≥„Ç∞
          MIME_TYPES = {
              '.ts': 'text/plain',
              '.tsx': 'text/plain',
              '.js': 'text/plain',
              '.jsx': 'text/plain',
              '.json': 'application/json',
              '.md': 'text/markdown',
              '.py': 'text/x-python',
              '.sh': 'text/x-shellscript',
              '.yml': 'text/yaml',
              '.yaml': 'text/yaml',
              '.css': 'text/css',
              '.html': 'text/html',
              '.sql': 'text/plain',
              '.prisma': 'text/plain',
              '.env.example': 'text/plain',
          }

          def get_mime_type(filename):
              ext = os.path.splitext(filename)[1].lower()
              return MIME_TYPES.get(ext, 'text/plain')

          # „Éï„Ç©„É´„ÉÄ„Ç≠„É£„ÉÉ„Ç∑„É•
          folder_cache = {}

          def get_or_create_folder(folder_path, parent_id):
              """„Éï„Ç©„É´„ÉÄ„ÇíÂèñÂæó„Åæ„Åü„ÅØ‰ΩúÊàê"""
              if folder_path in folder_cache:
                  return folder_cache[folder_path]
              
              parts = folder_path.split('/')
              current_parent = parent_id
              current_path = ''
              
              for part in parts:
                  if not part:
                      continue
                  current_path = f"{current_path}/{part}" if current_path else part
                  
                  if current_path in folder_cache:
                      current_parent = folder_cache[current_path]
                      continue
                  
                  # „Éï„Ç©„É´„ÉÄ„ÇíÊ§úÁ¥¢
                  query = f"name='{part}' and '{current_parent}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false"
                  results = service.files().list(q=query, fields='files(id, name)').execute()
                  items = results.get('files', [])
                  
                  if items:
                      current_parent = items[0]['id']
                  else:
                      # „Éï„Ç©„É´„ÉÄ„Çí‰ΩúÊàê
                      folder_metadata = {
                          'name': part,
                          'mimeType': 'application/vnd.google-apps.folder',
                          'parents': [current_parent]
                      }
                      folder = service.files().create(body=folder_metadata, fields='id').execute()
                      current_parent = folder['id']
                      print(f"üìÅ Created folder: {current_path}")
                  
                  folder_cache[current_path] = current_parent
              
              return current_parent

          def upload_or_update_file(file_path, parent_folder_id):
              """„Éï„Ç°„Ç§„É´„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åæ„Åü„ÅØÊõ¥Êñ∞"""
              filename = os.path.basename(file_path)
              mime_type = get_mime_type(filename)
              
              # Êó¢Â≠ò„Éï„Ç°„Ç§„É´„ÇíÊ§úÁ¥¢
              query = f"name='{filename}' and '{parent_folder_id}' in parents and trashed=false"
              results = service.files().list(q=query, fields='files(id, name)').execute()
              items = results.get('files', [])
              
              media = MediaFileUpload(file_path, mimetype=mime_type, resumable=True)
              
              if items:
                  # Êõ¥Êñ∞
                  file_id = items[0]['id']
                  file = service.files().update(
                      fileId=file_id,
                      media_body=media,
                      fields='id, name'
                  ).execute()
                  print(f"üîÑ Updated: {file_path}")
              else:
                  # Êñ∞Ë¶è‰ΩúÊàê
                  file_metadata = {
                      'name': filename,
                      'parents': [parent_folder_id]
                  }
                  file = service.files().create(
                      body=file_metadata,
                      media_body=media,
                      fields='id, name'
                  ).execute()
                  print(f"‚úÖ Uploaded: {file_path}")
              
              return file

          # „Éï„Ç°„Ç§„É´ÂêåÊúü
          synced_count = 0
          error_count = 0

          with open('files_to_sync.txt', 'r') as f:
              files = [line.strip() for line in f if line.strip()]

          print(f"üì¶ Syncing {len(files)} files...")

          for file_path in files:
              try:
                  if not os.path.isfile(file_path):
                      continue
                  
                  # „Éï„Ç©„É´„ÉÄ„Éë„Çπ„ÇíÂèñÂæó
                  dir_path = os.path.dirname(file_path)
                  
                  if dir_path:
                      parent_id = get_or_create_folder(dir_path, ROOT_FOLDER_ID)
                  else:
                      parent_id = ROOT_FOLDER_ID
                  
                  upload_or_update_file(file_path, parent_id)
                  synced_count += 1
                  
              except Exception as e:
                  print(f"‚ùå Error syncing {file_path}: {e}")
                  error_count += 1

          print(f"\nüéâ Sync complete!")
          print(f"   ‚úÖ Synced: {synced_count}")
          print(f"   ‚ùå Errors: {error_count}")

          # GitHub Actions„ÅÆ„Çµ„Éû„É™„Éº„Å´URL„ÇíÂá∫Âäõ
          with open(os.environ['GITHUB_STEP_SUMMARY'], 'a') as f:
              f.write(f"## üìÅ Google Drive Sync\n\n")
              f.write(f"‚úÖ **{synced_count} files synced**\n\n")
              if error_count > 0:
                  f.write(f"‚ö†Ô∏è **{error_count} errors**\n\n")
          EOF

      - name: Cleanup
        if: always()
        run: |
          rm -f credentials.json
          rm -f files_to_sync.txt