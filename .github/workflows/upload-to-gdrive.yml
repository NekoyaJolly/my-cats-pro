name: Sync Files to Google Drive

on:
  push:
    branches:
      - main
  workflow_dispatch:  # ÊâãÂãïÂÆüË°åÂèØËÉΩ

jobs:
  sync-to-drive:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Get changed files
        id: changed-files
        run: |
          # ÂàùÂõûÂÆüË°å„Åæ„Åü„ÅØÊâãÂãïÂÆüË°å„ÅÆÂ†¥Âêà„ÅØÂÖ®„Éï„Ç°„Ç§„É´„ÇíÂØæË±°
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "Manual trigger - syncing all files"
            find . -type f \
              ! -path './.git/*' \
              ! -path './node_modules/*' \
              ! -path './.next/*' \
              ! -path './dist/*' \
              ! -path './build/*' \
              ! -path './.env*' \
              ! -name '*.log' \
              ! -name '*.lock' \
              ! -name 'pnpm-lock.yaml' \
              ! -name 'package-lock.json' \
              ! -name '*.png' \
              ! -name '*.jpg' \
              ! -name '*.jpeg' \
              ! -name '*.gif' \
              ! -name '*.ico' \
              ! -name '*.woff' \
              ! -name '*.woff2' \
              ! -name '*.ttf' \
              ! -name '*.eot' \
              ! -name '*.xlsx' \
              ! -name '*.pdf' \
              | sed 's|^\./||' > files_to_sync.txt
          else
            # ÈÄöÂ∏∏„ÅÆ„Éó„ÉÉ„Ç∑„É• - Â§âÊõ¥„Éï„Ç°„Ç§„É´„ÅÆ„Åø
            git diff --name-only HEAD^ HEAD 2>/dev/null > files_to_sync.txt || \
            find . -type f \
              ! -path './.git/*' \
              ! -path './node_modules/*' \
              | sed 's|^\./||' > files_to_sync.txt
          fi
          
          # Â≠òÂú®„Åô„Çã„ÉÜ„Ç≠„Çπ„Éà„Éï„Ç°„Ç§„É´„ÅÆ„Åø„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
          tmp_file=$(mktemp)
          while read -r file; do
            if [ -f "$file" ]; then
              # „Éê„Ç§„Éä„É™„Éï„Ç°„Ç§„É´„ÇíÈô§Â§ñ
              if file "$file" | grep -q "text\|empty\|JSON\|ASCII"; then
                echo "$file" >> "$tmp_file"
              fi
            fi
          done < files_to_sync.txt
          mv "$tmp_file" files_to_sync.txt
          
          file_count=$(wc -l < files_to_sync.txt | tr -d ' ')
          echo "count=$file_count" >> $GITHUB_OUTPUT
          
          echo "Files to sync: $file_count"
          head -20 files_to_sync.txt

      - name: Setup Python
        if: steps.changed-files.outputs.count > 0
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Google API dependencies
        if: steps.changed-files.outputs.count > 0
        run: |
          pip install --upgrade pip
          pip install google-auth google-api-python-client

      - name: Setup Google Drive credentials
        if: steps.changed-files.outputs.count > 0
        run: |
          echo '${{ secrets.GOOGLE_DRIVE_CREDENTIALS }}' > credentials.json

      - name: Sync files to Google Drive
        if: steps.changed-files.outputs.count > 0
        env:
          GOOGLE_DRIVE_FOLDER_ID: ${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}
        run: |
          python << 'EOF'
          import os
          from google.oauth2 import service_account
          from googleapiclient.discovery import build
          from googleapiclient.http import MediaFileUpload

          SCOPES = ['https://www.googleapis.com/auth/drive']

          # Ë™çË®º
          credentials = service_account.Credentials.from_service_account_file(
              'credentials.json', scopes=SCOPES)
          service = build('drive', 'v3', credentials=credentials)

          ROOT_FOLDER_ID = os.environ.get('GOOGLE_DRIVE_FOLDER_ID', '')

          # „Éï„Ç©„É´„ÉÄ„Ç≠„É£„ÉÉ„Ç∑„É•
          folder_cache = {}

          def get_or_create_folder(folder_path, parent_id):
              """„Éï„Ç©„É´„ÉÄ„ÇíÂèñÂæó„Åæ„Åü„ÅØ‰ΩúÊàê"""
              if folder_path in folder_cache:
                  return folder_cache[folder_path]
              
              parts = folder_path.split('/')
              current_parent = parent_id
              current_path = ''
              
              for part in parts:
                  if not part:
                      continue
                  current_path = f"{current_path}/{part}" if current_path else part
                  
                  if current_path in folder_cache:
                      current_parent = folder_cache[current_path]
                      continue
                  
                  # „Éï„Ç©„É´„ÉÄ„ÇíÊ§úÁ¥¢
                  query = f"name='{part}' and '{current_parent}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false"
                  results = service.files().list(q=query, fields='files(id, name)').execute()
                  items = results.get('files', [])
                  
                  if items:
                      current_parent = items[0]['id']
                  else:
                      # „Éï„Ç©„É´„ÉÄ„Çí‰ΩúÊàêÔºà„Éï„Ç©„É´„ÉÄ„ÅØ„ÇØ„Ç©„Éº„Çø„ÇíÊ∂àË≤ª„Åó„Å™„ÅÑÔºâ
                      folder_metadata = {
                          'name': part,
                          'mimeType': 'application/vnd.google-apps.folder',
                          'parents': [current_parent]
                      }
                      folder = service.files().create(body=folder_metadata, fields='id').execute()
                      current_parent = folder['id']
                      print(f"üìÅ Created folder: {current_path}")
                  
                  folder_cache[current_path] = current_parent
              
              return current_parent

          def upload_as_google_doc(file_path, parent_folder_id):
              """„Éï„Ç°„Ç§„É´„ÇíGoogle DocsÂΩ¢Âºè„Åß„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÔºà„ÇØ„Ç©„Éº„ÇøÊ∂àË≤ª„Å™„ÅóÔºâ"""
              filename = os.path.basename(file_path)
              # Êã°ÂºµÂ≠ê„ÇíÈô§„ÅÑ„ÅüÂêçÂâç + ÂÖÉ„ÅÆÊã°ÂºµÂ≠ê„ÇíÂêçÂâç„Å´Âê´„ÇÅ„Çã
              doc_name = filename
              
              # Êó¢Â≠ò„Éï„Ç°„Ç§„É´„ÇíÊ§úÁ¥¢ÔºàGoogle DocsÂΩ¢ÂºèÔºâ
              query = f"name='{doc_name}' and '{parent_folder_id}' in parents and mimeType='application/vnd.google-apps.document' and trashed=false"
              results = service.files().list(q=query, fields='files(id, name)').execute()
              items = results.get('files', [])
              
              # „Éï„Ç°„Ç§„É´ÂÜÖÂÆπ„ÇíË™≠„ÅøËæº„Åø
              try:
                  with open(file_path, 'r', encoding='utf-8') as f:
                      content = f.read()
              except UnicodeDecodeError:
                  with open(file_path, 'r', encoding='latin-1') as f:
                      content = f.read()
              
              if items:
                  # Êó¢Â≠ò„Éï„Ç°„Ç§„É´„ÇíÂâäÈô§„Åó„Å¶ÂÜç‰ΩúÊàêÔºàGoogle Docs„ÅØÁõ¥Êé•Êõ¥Êñ∞„ÅåË§áÈõë„Å™„Åü„ÇÅÔºâ
                  file_id = items[0]['id']
                  service.files().delete(fileId=file_id).execute()
              
              # Êñ∞Ë¶è‰ΩúÊàêÔºàGoogle DocsÂΩ¢ÂºèÔºâ
              file_metadata = {
                  'name': doc_name,
                  'mimeType': 'application/vnd.google-apps.document',
                  'parents': [parent_folder_id]
              }
              
              # ‰∏ÄÊôÇ„Éï„Ç°„Ç§„É´„Å´Êõ∏„ÅçÂá∫„Åó„Å¶„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ
              media = MediaFileUpload(file_path, mimetype='text/plain', resumable=True)
              
              file = service.files().create(
                  body=file_metadata,
                  media_body=media,
                  fields='id, name'
              ).execute()
              
              print(f"‚úÖ Uploaded: {file_path}")
              return file

          # „Éï„Ç°„Ç§„É´ÂêåÊúü
          synced_count = 0
          error_count = 0

          with open('files_to_sync.txt', 'r') as f:
              files = [line.strip() for line in f if line.strip()]

          print(f"üì¶ Syncing {len(files)} files as Google Docs...")

          for file_path in files:
              try:
                  if not os.path.isfile(file_path):
                      continue
                  
                  # „Éï„Ç©„É´„ÉÄ„Éë„Çπ„ÇíÂèñÂæó
                  dir_path = os.path.dirname(file_path)
                  
                  if dir_path:
                      parent_id = get_or_create_folder(dir_path, ROOT_FOLDER_ID)
                  else:
                      parent_id = ROOT_FOLDER_ID
                  
                  upload_as_google_doc(file_path, parent_id)
                  synced_count += 1
                  
              except Exception as e:
                  print(f"‚ùå Error syncing {file_path}: {e}")
                  error_count += 1

          print(f"\nüéâ Sync complete!")
          print(f"   ‚úÖ Synced: {synced_count}")
          print(f"   ‚ùå Errors: {error_count}")

          # GitHub Actions„ÅÆ„Çµ„Éû„É™„Éº„Å´Âá∫Âäõ
          with open(os.environ['GITHUB_STEP_SUMMARY'], 'a') as f:
              f.write(f"## üìÅ Google Drive Sync\n\n")
              f.write(f"‚úÖ **{synced_count} files synced as Google Docs**\n\n")
              if error_count > 0:
                  f.write(f"‚ö†Ô∏è **{error_count} errors**\n\n")
          EOF

      - name: Cleanup
        if: always()
        run: |
          rm -f credentials.json
          rm -f files_to_sync.txt