name: Sync Domain Files to Google Drive

on:
  push:
    branches:
      - main
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œå¯èƒ½

jobs:
  sync-domains:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install repomix
        run: npm install -g repomix

      - name: Create output directory
        run: mkdir -p dist_notebook

      - name: Generate Domain_Cats.md
        run: |
          npx repomix \
            --include "backend/prisma/schema.prisma,backend/src/cats/**,backend/src/breeds/**,backend/src/coat-colors/**,backend/src/gallery/**,backend/src/gallery-upload/**,frontend/src/app/cats/**,frontend/src/app/gallery/**,frontend/src/components/cats/**" \
            --output dist_notebook/Domain_Cats.md \
            --style markdown
          echo "# Domain: çŒ«ç®¡ç† (Cat Management)" | cat - dist_notebook/Domain_Cats.md > tmp && mv tmp dist_notebook/Domain_Cats.md

      - name: Generate Domain_Breeding.md
        run: |
          npx repomix \
            --include "backend/prisma/schema.prisma,backend/src/breeding/**,backend/src/graduation/**,frontend/src/app/breeding/**,frontend/src/app/kittens/**" \
            --output dist_notebook/Domain_Breeding.md \
            --style markdown
          echo "# Domain: ç¹æ®–ç®¡ç† (Breeding Management)" | cat - dist_notebook/Domain_Breeding.md > tmp && mv tmp dist_notebook/Domain_Breeding.md

      - name: Generate Domain_Pedigree.md
        run: |
          npx repomix \
            --include "backend/prisma/schema.prisma,backend/src/pedigree/**,frontend/src/app/pedigrees/**" \
            --output dist_notebook/Domain_Pedigree.md \
            --style markdown
          echo "# Domain: è¡€çµ±æ›¸ (Pedigree)" | cat - dist_notebook/Domain_Pedigree.md > tmp && mv tmp dist_notebook/Domain_Pedigree.md

      - name: Generate Domain_Care.md
        run: |
          npx repomix \
            --include "backend/prisma/schema.prisma,backend/src/care/**,frontend/src/app/care/**,frontend/src/app/medical-records/**" \
            --output dist_notebook/Domain_Care.md \
            --style markdown
          echo "# Domain: ã‚±ã‚¢ãƒ»åŒ»ç™‚ (Care & Medical)" | cat - dist_notebook/Domain_Care.md > tmp && mv tmp dist_notebook/Domain_Care.md

      - name: Generate Domain_Settings.md
        run: |
          npx repomix \
            --include "backend/prisma/schema.prisma,backend/src/tags/**,backend/src/tenants/**,backend/src/users/**,backend/src/auth/**,backend/src/shift/**,backend/src/staff/**,frontend/src/app/tags/**,frontend/src/app/tenants/**,frontend/src/app/settings/**,frontend/src/app/staff/**" \
            --output dist_notebook/Domain_Settings.md \
            --style markdown
          echo "# Domain: ã‚·ã‚¹ãƒ†ãƒ è¨­å®š (System Settings)" | cat - dist_notebook/Domain_Settings.md > tmp && mv tmp dist_notebook/Domain_Settings.md

      - name: Generate Domain_Common.md
        run: |
          npx repomix \
            --include "backend/src/common/**,frontend/src/components/**,frontend/src/lib/**" \
            --output dist_notebook/Domain_Common.md \
            --style markdown
          echo "# Domain: å…±é€šã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ (Common)" | cat - dist_notebook/Domain_Common.md > tmp && mv tmp dist_notebook/Domain_Common.md

      - name: List generated files
        run: |
          echo "Generated domain files:"
          ls -la dist_notebook/
          echo ""
          echo "File sizes:"
          du -h dist_notebook/*

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Google API dependencies
        run: |
          pip install --upgrade pip
          pip install google-auth google-auth-oauthlib google-api-python-client

      - name: Setup OAuth credentials
        run: |
          echo '${{ secrets.GOOGLE_OAUTH_CREDENTIALS }}' > oauth-token.json

      - name: Upload domain files to Google Drive
        env:
          GOOGLE_DRIVE_FOLDER_ID: ${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}
        run: |
          python << 'EOF'
          import os
          import json
          from google.oauth2.credentials import Credentials
          from google.auth.transport.requests import Request
          from googleapiclient.discovery import build
          from googleapiclient.http import MediaFileUpload

          # OAuth2èªè¨¼
          with open('oauth-token.json', 'r') as f:
              token_data = json.load(f)

          creds = Credentials(
              token=None,
              refresh_token=token_data['refresh_token'],
              token_uri='https://oauth2.googleapis.com/token',
              client_id=token_data['client_id'],
              client_secret=token_data['client_secret']
          )
          creds.refresh(Request())

          service = build('drive', 'v3', credentials=creds)
          ROOT_FOLDER_ID = os.environ.get('GOOGLE_DRIVE_FOLDER_ID', '')

          def upload_or_update_file(file_path, parent_folder_id):
              """ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã¾ãŸã¯æ›´æ–°"""
              filename = os.path.basename(file_path)
              
              # æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢
              query = f"name='{filename}' and '{parent_folder_id}' in parents and trashed=false"
              results = service.files().list(q=query, fields='files(id, name)').execute()
              items = results.get('files', [])
              
              media = MediaFileUpload(file_path, mimetype='text/markdown', resumable=True)
              
              if items:
                  # æ›´æ–°
                  file_id = items[0]['id']
                  file = service.files().update(
                      fileId=file_id,
                      media_body=media,
                      fields='id, name'
                  ).execute()
                  print(f"ðŸ”„ Updated: {filename}")
              else:
                  # æ–°è¦ä½œæˆ
                  file_metadata = {
                      'name': filename,
                      'parents': [parent_folder_id]
                  }
                  file = service.files().create(
                      body=file_metadata,
                      media_body=media,
                      fields='id, name'
                  ).execute()
                  print(f"âœ… Uploaded: {filename}")
              
              return file

          # ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
          domain_files = [
              'dist_notebook/Domain_Cats.md',
              'dist_notebook/Domain_Breeding.md',
              'dist_notebook/Domain_Pedigree.md',
              'dist_notebook/Domain_Care.md',
              'dist_notebook/Domain_Settings.md',
              'dist_notebook/Domain_Common.md',
          ]

          print(f"ðŸ“¦ Uploading {len(domain_files)} domain files to Google Drive...")

          for file_path in domain_files:
              if os.path.isfile(file_path):
                  upload_or_update_file(file_path, ROOT_FOLDER_ID)
              else:
                  print(f"âš ï¸ File not found: {file_path}")

          print(f"\nðŸŽ‰ Domain sync complete!")

          # GitHub Actionsã®ã‚µãƒžãƒªãƒ¼ã«å‡ºåŠ›
          with open(os.environ['GITHUB_STEP_SUMMARY'], 'a') as f:
              f.write(f"## ðŸ“ Domain Files Synced to Google Drive\n\n")
              for file_path in domain_files:
                  if os.path.isfile(file_path):
                      size = os.path.getsize(file_path)
                      f.write(f"- âœ… `{os.path.basename(file_path)}` ({size:,} bytes)\n")
          EOF

      - name: Cleanup
        if: always()
        run: |
          rm -f oauth-token.json
          rm -rf dist_notebook