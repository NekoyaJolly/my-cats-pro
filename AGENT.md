## 1. このファイルの目的

このリポジトリで作業する **AI アシスタント / Copilot / Claude / LLM エージェント** に対して:

- プロジェクトの構造と役割をすばやく理解させる  
- Next.js 15（App Router）/ NestJS 10 / Prisma 6 / PostgreSQL を前提に、**公式ベストプラクティスに沿った変更のみ**を行わせる  
- 型安全・最小変更・一貫性・再利用性を重視させ、  
  - `any` 多用  
  - エラー無視  
  - 無関係な大規模リファクタリング  
  - コピペによる重複実装  
  を防ぐ

ことを目的とした **「行動規範」 + 「プロンプトテンプレート」** です。

---

## 2. 技術スタックと前提

- フロントエンド
  - Next.js 15（App Router / React Server Components）
  - React 19
  - TypeScript 5
  - Mantine / Tailwind CSS
- バックエンド
  - NestJS 10（モジュール構成 / DI / Pipes / Guards）
  - Prisma 6.14.0
  - PostgreSQL 15+
- 開発環境
  - Node.js 20.x
  - pnpm 9.x

**原則**:  
Next.js / NestJS / Prisma / TypeScript の **公式ドキュメント**と、この `AGENT.md` に書かれた方針が矛盾する場合は、**公式ドキュメントに準拠しつつ、その旨を説明したうえで提案する**こと。

---

## 3. プロジェクト構造のざっくりマップ

AI はコードを読む前提で、最低限この構造を頭に入れてください。

- `frontend/`
  - `src/app/`  
    - App Router のルーティング・ページ・レイアウト
  - `src/components/`  
    - 再利用可能な UI コンポーネント
  - `next.config.ts`  
    - Next.js 設定
- `backend/`
  - `src/`  
    - NestJS モジュール（`cats`, `pedigree`, `breeding`, `care`, `users`, `auth` など）
  - `prisma/`  
    - `schema.prisma` / マイグレーション
  - `test/`  
    - e2e 等のテスト
- `docs/` / `DATABASE_*.md`  
  - システム設計 / API 仕様 / DB 設計
- `scripts/` / `nginx/` / `pnpm-workspace.yaml` など  
  - インフラ・ワークスペース管理

**ルール**:  
新しいコード・ファイルを追加する際は、**もっとも近い責務を持つディレクトリに置き、既存の構造・命名規則に従う**こと。

---

## 4. 型安全に関する絶対ルール

### 4-1. `any` 完全禁止（例外は要説明）

- `any` 型の利用は **原則禁止**。
- やむを得ず `any` を使う場合:
  - 具体的な理由をコメントで明記すること:
    - `// TODO: narrow type, currently any because <理由>`
  - 将来的に絞り込める設計（型ガード・スキーマ・DTO）を優先すること。

### 4-2. 乱暴な型アサーション禁止

- 次のような書き方は禁止:
  - `value as any`
  - `value as unknown as X`
- 代わりに:
  - 型ガード関数 (`isX(value: unknown): value is X`) を定義する
  - Zod / class-validator / Prisma の型をベースに「正しい形」から導出する

### 4-3. API 入出力は必ず型定義経由

- フロントエンド:
  - API クライアント層や `types/` にレスポンス・リクエスト型を定義し、それをコンポーネントで使い回す。
- バックエンド:
  - DTO / Prisma Model / レスポンス型を使い回す。
  - 同じ構造の型を複数箇所で重複定義しない。

---

## 5. エラー処理とロギング

### 5-1. エラー無視禁止

禁止例:

- `catch (e) {}`（空の catch）
- `catch (e) { console.error(e) }` だけで終了
- `// @ts-ignore` で型エラーを握りつぶす
- `eslint-disable-next-line` の乱用
- `void someAsync()` による Fire-and-forget（意図を説明しない）

代わりに:

- バックエンド:
  - NestJS の `HttpException` / カスタム例外を用いて HTTP レスポンスへ変換
  - 重要なエラーは Logger 経由で記録
- フロントエンド:
  - ユーザー向けのエラーメッセージ表示 or ロギングレイヤーへの送信
  - 失敗状態を UI 上でハンドリング（ローディング/エラー表示など）

### 5-2. エラーの型付け

- エラーオブジェクトに型を与える（`Error`, `ZodError`, `Prisma.PrismaClientKnownRequestError` など）。
- `unknown` を受け取ったら、型ガードで絞る。

---

## 6. 変更スコープに関するルール

### 6-1. 無関係なリファクタリング禁止

AI は、ユーザーに依頼されていないリファクタリングを勝手に広げてはいけません。

禁止:

- 関連しないファイルの命名変更・大規模な関数分割
- import パス変更を全体に波及させる
- 単なるフォーマット変更だけの大量編集

許可される範囲:

- 触っているファイル内での小規模な改善（明らかなバグ・型エラー修正など）
- 変更対象機能に密接に関係する箇所に限ったリファクタリング

### 6-2. 重複実装禁止

新しい実装を書く前に、必ず:

- 似た API / DTO / コンポーネントが既にないか探す
- 同じバリデーション・同じ UI パターンがあればそれを再利用する

**同じ構造のコードをコピペして増やすのではなく、「抽象化」か「再利用」で対応すること。**

---

## 7. Next.js（App Router）向けの方針

公式: https://nextjs.org/docs/app

AI は以下を守ること:

1. **App Router 構成**
   - ページは `frontend/src/app` 以下のディレクトリ構造に従う。
   - `page.tsx` / `layout.tsx` / `loading.tsx` / `error.tsx` など、App Router のファイル規約を守る。

2. **サーバーコンポーネント優先**
   - 可能な限り Server Components を使い、必要な箇所のみ Client Components にする。
   - `use client` は最小限に留める。

3. **データフェッチとキャッシュ**
   - サーバーでのデータ取得を優先し、Next.js のデータキャッシュ戦略（`fetch` のオプション / 再検証）に従う。
   - 不要なクライアントサイドフェッチを避ける。

4. **フォーム / ミューテーション**
   - Next.js のフォーム／サーバーアクションのベストプラクティスに従い、CSRF・バリデーションを考慮。

---

## 8. NestJS + Prisma 向けの方針

公式:  
- NestJS: https://docs.nestjs.com/  
- Prisma: https://www.prisma.io/docs/

AI は以下を守ること:

1. **レイヤリング**
   - モジュール (`Module`), サービス (`Service`), コントローラ (`Controller`), DTO を明確に分ける。
   - Controller から直接 Prisma Client を呼ばない（必ず Service 経由）。

2. **DTO + class-validator**
   - 入出力は DTO クラスで定義し、`class-validator` でバリデーションを行う。
   - DTO と Entity / Prisma Model の責務を混同しない。

3. **Prisma クエリ**
   - N+1 問題を避けるために `include` や `select` を適切に使用。
   - 不要なフィールドを取らない（必要なものだけ `select`）。

4. **マイグレーション**
   - `schema.prisma` 変更時は必ずマイグレーションを通す。
   - 破壊的変更（カラム削除・型変更）は影響範囲を説明したうえで提案すること。

---

## 9. フォルダごとのローカルルール (`CODE_GUIDE.md`)

- 各主要フォルダ（例: `frontend/src/app`, `frontend/src/components`, `backend/src/cats`, `backend/prisma`）には
  **フォルダ専用のルール** をまとめた `CODE_GUIDE.md` を置く。
- AI エージェントは、**変更対象フォルダに `CODE_GUIDE.md` が存在する場合、必ずそれを読んでから作業すること**。
- `CODE_GUIDE.md` は「このフォルダのローカルな具体化ルール」であり、ここに書かれた方針は `AGENT.md` の共通ルールと矛盾しない範囲で上書きされる。

---

## 10. AI への依頼時に使う日本語プロンプトテンプレ

### 10-1. 機能追加リクエスト用プロンプト

```text
あなたは mycats-pro プロジェクト専任の AI コーディングエージェントです。
Next.js 15（App Router）+ React 19 + NestJS 10 + Prisma 6 + PostgreSQL 15 のベストプラクティスと、
リポジトリ直下の AGENT.md に書かれているルールに従ってください。

【やりたいこと】
- 機能概要: （ここに概要を書く）
- 対象画面 / API: （例: frontend/src/app/cats, backend/src/cats など）

【必ず守ってほしいこと】
- any 型は使わず、既存の型定義や DTO を再利用・拡張してください。
- エラーを無視せず、NestJS / Next.js のベストプラクティスに沿ってハンドリングしてください。
- 関係ないファイルの大規模リファクタリングは行わず、変更は最小限のスコープにとどめてください。
- 既存の似た実装（画面 / API / DTO / コンポーネント）があれば、それを再利用または参考にしてください。

【出力してほしいこと】
1. 変更するファイル一覧（パス付き）と各ファイルの役割
2. 主要なコード変更点の要約（型安全性のポイントも含める）
3. 追加・更新が必要なテストと、その意図
4. 動作確認に使用するコマンド例（pnpm を使ったテスト・起動コマンドなど）
```

### 10-2. バグ修正リクエスト用プロンプト

```text
あなたは mycats-pro プロジェクト専任の AI コーディングエージェントです。
Next.js / NestJS / Prisma のベストプラクティスと AGENT.md に従って、以下のバグを修正してください。

【バグ内容】
- 現象: （何がどうおかしいか）
- 再現手順: （URL, 操作手順など）
- 期待する挙動: （どうなっていてほしいか）

【制約】
- 修正は、原因箇所とその周辺にスコープを限定してください（無関係なリファクタリングは禁止）。
- any や ts-ignore でごまかさず、型安全な形で原因を修正してください。
- 可能であれば、このバグを再発防止できるテストを追加してください。

【出力してほしいこと】
1. 想定される原因と、その根拠
2. 修正するファイル一覧と変更内容の概要
3. 追加・修正したテスト内容
4. 再現確認と回帰確認に使うコマンド/手順
```

---

## 11. 期待する回答スタイル（AI 向け）

- 日本語で簡潔かつ情報密度高く説明すること。
- 一般論よりも、このリポジトリに即した具体的な提案を優先すること。
- コードは必要な最小限の部分に絞り、ファイル全体は極力貼らないこと。
- 可能な限りテスト方針と実行コマンドを一緒に提示すること。

---
