# Google Cloud Build Configuration
# This file defines the CI/CD pipeline for building, testing, and deploying the application.

steps:
  # 1. Build the backend Docker image
  - name: 'gcr.io/cloud-builders/docker'
    id: 'Build Backend'
    args:
      - 'build'
      - '-t'
      - '${_LOCATION}-docker.pkg.dev/${PROJECT_ID}/${_REPO_NAME}/backend:latest'
      - '-f'
      - 'Dockerfile.backend'
      - '.'
    waitFor: ['-']

  # 2. Build the frontend Docker image
  - name: 'gcr.io/cloud-builders/docker'
    id: 'Build Frontend'
    args:
      - 'build'
      - '-t'
      - '${_LOCATION}-docker.pkg.dev/${PROJECT_ID}/${_REPO_NAME}/frontend:latest'
      # Pass the public API URL as a build argument for the frontend
      - '--build-arg'
      - 'NEXT_PUBLIC_API_URL=${_NEXT_PUBLIC_API_URL}'
      - '-f'
      - 'Dockerfile.frontend'
      - '.'
    waitFor: ['-']

  # 3. Push the backend image to Artifact Registry
  - name: 'gcr.io/cloud-builders/docker'
    id: 'Push Backend'
    args: 
      - 'push'
      - '${_LOCATION}-docker.pkg.dev/${PROJECT_ID}/${_REPO_NAME}/backend:latest'
    waitFor: ['Build Backend']

  # 4. Push the frontend image to Artifact Registry
  - name: 'gcr.io/cloud-builders/docker'
    id: 'Push Frontend'
    args:
      - 'push'
      - '${_LOCATION}-docker.pkg.dev/${PROJECT_ID}/${_REPO_NAME}/frontend:latest'
    waitFor: ['Build Frontend']

  # 5. Deploy Backend to Cloud Run (migration will run on startup)
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'Deploy Backend'
    entrypoint: gcloud
    args:
      - 'run'
      - 'deploy'
      - '${_BACKEND_SERVICE_NAME}'
      - '--image'
      - '${_LOCATION}-docker.pkg.dev/${PROJECT_ID}/${_REPO_NAME}/backend:latest'
      - '--region'
      - '${_LOCATION}'
      - '--platform'
      - 'managed'
      - '--allow-unauthenticated' # Or configure authentication as needed
      - '--set-secrets=DATABASE_URL=DATABASE_URL:latest,JWT_SECRET=JWT_SECRET:latest,JWT_REFRESH_SECRET=JWT_REFRESH_SECRET:latest'
      - '--set-env-vars=NODE_ENV=production,CORS_ORIGIN=${_CORS_ORIGIN},PORT=8080'
      - '--add-cloudsql-instances=${_CLOUD_SQL_CONNECTION_NAME}'
      - '--max-instances=3'
      - '--min-instances=0'
      - '--memory=512Mi'
      - '--cpu=1'
      - '--timeout=300'
    waitFor: ['Push Backend']

  # 6. Deploy Frontend to Cloud Run
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'Deploy Frontend'
    entrypoint: gcloud
    args:
      - 'run'
      - 'deploy'
      - '${_FRONTEND_SERVICE_NAME}'
      - '--image'
      - '${_LOCATION}-docker.pkg.dev/${PROJECT_ID}/${_REPO_NAME}/frontend:latest'
      - '--region'
      - '${_LOCATION}'
      - '--platform'
      - 'managed'
      - '--allow-unauthenticated'
      - '--set-env-vars=NODE_ENV=production,NEXT_PUBLIC_API_URL=${_NEXT_PUBLIC_API_URL}'
    waitFor: ['Push Frontend']

# Define images to be pushed to Artifact Registry
images:
  - '${_LOCATION}-docker.pkg.dev/${PROJECT_ID}/${_REPO_NAME}/backend:latest'
  - '${_LOCATION}-docker.pkg.dev/${PROJECT_ID}/${_REPO_NAME}/frontend:latest'

# Define substitution variables that can be passed at build time
substitutions:
  _LOCATION: 'asia-northeast1' # Tokyo region
  _REPO_NAME: 'mycats-pro'
  _BACKEND_SERVICE_NAME: 'mycats-pro-backend'
  _FRONTEND_SERVICE_NAME: 'mycats-pro-frontend'
  # These will be auto-generated after first deploy, update after initial deployment
  _NEXT_PUBLIC_API_URL: 'https://mycats-pro-backend-XXXXXXXXXX-an.a.run.app/api/v1'
  _CORS_ORIGIN: 'https://mycats-pro-frontend-XXXXXXXXXX-an.a.run.app'
  _CLOUD_SQL_CONNECTION_NAME: 'my-cats-pro:asia-northeast1:mycats-prod-db'

options:
  logging: CLOUD_LOGGING_ONLY
