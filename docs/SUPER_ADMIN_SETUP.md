# æœ¬ç•ªç’°å¢ƒ åˆå› SUPER ADMIN ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¬ã‚¤ãƒ‰

æœ¬ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€æœ¬ç•ªç’°å¢ƒã§æœ€åˆã® SUPER_ADMIN ã‚’ä½œæˆã™ã‚‹æ‰‹é †ã‚’èª¬æ˜ã—ã¾ã™ã€‚

## 1. æ¦‚è¦

æœ¬ç•ªç’°å¢ƒã«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸå¾Œã€ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã‚’ç®¡ç†ã™ã‚‹ãŸã‚ã® SUPER_ADMIN æ¨©é™ã‚’æŒã¤ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå¿…è¦ã§ã™ã€‚ã“ã® SUPER_ADMIN ã¯ã€å…¨ãƒ†ãƒŠãƒ³ãƒˆãƒ»å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç®¡ç†ã§ãã‚‹æœ€ä¸Šä½æ¨©é™ã‚’æŒã¡ã¾ã™ã€‚

ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®ç†ç”±ã‹ã‚‰ã€ã“ã®æ˜‡æ ¼æ“ä½œã¯ **ä¸€åº¦ã ã‘** å®Ÿè¡Œå¯èƒ½ã§ã™ã€‚SUPER_ADMIN ãŒã™ã§ã«å­˜åœ¨ã™ã‚‹å ´åˆã¯ã‚¨ãƒ©ãƒ¼ã¨ãªã‚Šã¾ã™ã€‚

## 2. å‰ææ¡ä»¶

- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒæœ¬ç•ªç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤æ¸ˆã¿ã§ã‚ã‚‹ã“ã¨
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒå®Œäº†ã—ã¦ã„ã‚‹ã“ã¨
- ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦æ–°è¦ç™»éŒ²ãƒ»ãƒ­ã‚°ã‚¤ãƒ³ãŒã§ãã‚‹çŠ¶æ…‹ã§ã‚ã‚‹ã“ã¨

## 3. ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †

### 3-1. ç®¡ç†è€…ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’æ–°è¦ç™»éŒ²

1. ãƒ–ãƒ©ã‚¦ã‚¶ã§ `/register` ãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™
2. SUPER_ADMIN ã¨ã—ã¦ä½¿ç”¨ã™ã‚‹ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ç™»éŒ²ã—ã¾ã™

> **ğŸ’¡ ãƒ’ãƒ³ãƒˆ**: ç®¡ç†å°‚ç”¨ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆä¾‹: `admin@your-domain.com`ï¼‰ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™ã€‚

### 3-2. ãƒ­ã‚°ã‚¤ãƒ³

1. `/login` ãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™
2. ç™»éŒ²ã—ãŸãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã™

### 3-3. SUPER_ADMIN ã«æ˜‡æ ¼

1. `/setup/first-superadmin` ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™
2. ç¾åœ¨ãƒ­ã‚°ã‚¤ãƒ³ä¸­ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™
3. **ã€Œã“ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ SUPER ADMIN ã«æ˜‡æ ¼ã™ã‚‹ã€** ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™
4. ã€Œæ˜‡æ ¼ãŒå®Œäº†ã—ã¾ã—ãŸã€ã¨ã„ã†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚ŒãŸã‚‰æˆåŠŸã§ã™

### 3-4. å‹•ä½œç¢ºèª

1. æ˜‡æ ¼å®Œäº†ç”»é¢ã® **ã€Œãƒ†ãƒŠãƒ³ãƒˆç®¡ç†ãƒšãƒ¼ã‚¸ã¸ã€** ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã‹ã€`/tenants` ã«ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™
2. ãƒ†ãƒŠãƒ³ãƒˆç®¡ç†ãƒšãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚Œã°ã€SUPER_ADMIN ã¨ã—ã¦æ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™

## 4. æ³¨æ„äº‹é …

| é …ç›® | èª¬æ˜ |
|------|------|
| **ä¸€åº¦ã ã‘å®Ÿè¡Œå¯èƒ½** | ã“ã®æ˜‡æ ¼æ“ä½œã¯åˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å°‚ç”¨ã§ã™ã€‚SUPER_ADMIN ãŒã™ã§ã«å­˜åœ¨ã™ã‚‹å ´åˆã¯ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ |
| **å†ãƒ­ã‚°ã‚¤ãƒ³æ¨å¥¨** | æ˜‡æ ¼å¾Œã€JWT ãƒˆãƒ¼ã‚¯ãƒ³ã®æ¨©é™æƒ…å ±ã‚’æ›´æ–°ã™ã‚‹ãŸã‚ã€ä¸€åº¦ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¦å†ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™ |
| **æ¨©é™ã®ç¯„å›²** | SUPER_ADMIN ã¯å…¨ãƒ†ãƒŠãƒ³ãƒˆãƒ»å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç®¡ç†ã§ãã‚‹æœ€ä¸Šä½æ¨©é™ã‚’æŒã¡ã¾ã™ |

## 5. ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã€ŒSUPER ADMIN ã¯ã™ã§ã«å­˜åœ¨ã™ã‚‹ãŸã‚ã€ã“ã®æ“ä½œã¯å®Ÿè¡Œã§ãã¾ã›ã‚“ã€ã¨è¡¨ç¤ºã•ã‚Œã‚‹

**åŸå› **: ã™ã§ã«åˆ¥ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ SUPER_ADMIN ã«æ˜‡æ ¼æ¸ˆã¿ã§ã™ã€‚

**å¯¾å‡¦æ³•**:
- æ—¢å­˜ã® SUPER_ADMIN ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„
- ä¸æ˜ãªå ´åˆã¯ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§ `role = 'SUPER_ADMIN'` ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„

### æ˜‡æ ¼å¾Œã‚‚ãƒ†ãƒŠãƒ³ãƒˆç®¡ç†ãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„

**åŸå› **: JWT ãƒˆãƒ¼ã‚¯ãƒ³ã«å¤ã„æ¨©é™æƒ…å ±ãŒæ®‹ã£ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

**å¯¾å‡¦æ³•**:
1. ä¸€åº¦ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™
2. å†åº¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã™
3. `/tenants` ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™

### `/setup/first-superadmin` ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã‚‹

**åŸå› **: ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ãªã„çŠ¶æ…‹ã§ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã„ã¾ã™ã€‚

**å¯¾å‡¦æ³•**:
1. `/login` ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã‹ã‚‰å†åº¦ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„
2. ãƒ­ã‚°ã‚¤ãƒ³å¾Œã€è‡ªå‹•çš„ã« `/setup/first-superadmin` ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã¾ã™

## 6. æŠ€è¡“çš„ãªè©³ç´°ï¼ˆé–‹ç™ºè€…å‘ã‘ï¼‰

### API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

| ãƒ¡ã‚½ãƒƒãƒ‰ | ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ | èª¬æ˜ |
|----------|----------------|------|
| POST | `/api/v1/users/promote-to-superadmin-once` | ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ SUPER_ADMIN ã«æ˜‡æ ¼ |

### å‡¦ç†ãƒ•ãƒ­ãƒ¼

```mermaid
sequenceDiagram
    participant B as ãƒ–ãƒ©ã‚¦ã‚¶
    participant API as Backend API
    participant DB as Database

    B->>API: POST /users/promote-to-superadmin-once
    API->>DB: SUPER_ADMIN ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯
    alt SUPER_ADMIN ãŒå­˜åœ¨ã—ãªã„
        DB-->>API: count = 0
        API->>DB: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã® role ã‚’ SUPER_ADMIN ã«æ›´æ–°
        DB-->>API: æ›´æ–°å®Œäº†
        API-->>B: 200 OK { success: true, data: { id, email, role } }
    else SUPER_ADMIN ãŒå­˜åœ¨ã™ã‚‹
        DB-->>API: count > 0
        API-->>B: 403 Forbidden
    end
```

### ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹

**æˆåŠŸæ™‚ (200 OK):**
```json
{
  "success": true,
  "data": {
    "id": "uuid-string",
    "email": "admin@example.com",
    "role": "SUPER_ADMIN"
  }
}
```

**å¤±æ•—æ™‚ (403 Forbidden):**
```json
{
  "statusCode": 403,
  "message": "SUPER_ADMINã¯ã™ã§ã«å­˜åœ¨ã—ã¾ã™",
  "error": "Forbidden"
}
```

### é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«

| ãƒ•ã‚¡ã‚¤ãƒ« | èª¬æ˜ |
|----------|------|
| `backend/src/users/users.service.ts` | æ˜‡æ ¼ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆ`promoteToSuperAdminOnce`ï¼‰ |
| `backend/src/users/users.controller.ts` | API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå®šç¾© |
| `frontend/src/app/setup/first-superadmin/page.tsx` | ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ UI |

---
Last Update: 2025-11-28
